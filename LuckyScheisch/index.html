<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Lucky Scheisch</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Arial, sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background:
        radial-gradient(circle at top, #8c4b20 0%, #1a080b 35%, #050308 100%);
      color: #fbecc7;
      overflow: hidden;
    }

    .game-wrapper {
      width: 1180px;
      max-width: 100%;
      padding: 20px 30px 26px;
      background: radial-gradient(circle at top, #261018, #050308);
      border-radius: 24px;
      border: 4px solid #d6af3b;
      box-shadow:
        0 0 45px rgba(0, 0, 0, 0.95),
        0 0 30px rgba(255, 215, 128, 0.35) inset;
      position: relative;
      overflow: hidden;
    }

    /* --- Intro Overlay (Start) --- */

    .intro-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0,0,0,0.95), rgba(0,0,0,0.98));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 60;
      text-align: center;
      padding: 24px;
    }

    .intro-title {
      font-size: 42px;
      margin-bottom: 10px;
      letter-spacing: 3px;
      color: #ffe37a;
      text-shadow:
        0 0 15px rgba(0,0,0,0.9),
        0 0 25px rgba(255, 215, 128, 0.9);
    }

    .intro-sub {
      font-size: 15px;
      color: #f3d9a0;
      max-width: 540px;
      line-height: 1.5;
      margin-bottom: 24px;
    }

    .intro-logo {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 10%, #ffffff 0, #f5d473 20%, #d8923c 40%, #5e2914 80%);
      border: 4px solid #f7e29b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
      margin-bottom: 18px;
      box-shadow:
        0 0 22px rgba(0,0,0,0.9),
        0 0 40px rgba(255, 228, 162, 0.8);
    }

    .btn-big {
      padding: 11px 28px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 18px;
      font-weight: 700;
      color: #3b240b;
      background: linear-gradient(135deg, #ffe68a, #d9a634);
      box-shadow:
        0 3px 0 #8f6c1d,
        0 0 25px rgba(255, 215, 128, 0.9);
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    .btn-big:hover {
      filter: brightness(1.06);
      transform: translateY(-1px);
    }

    .btn-big:active {
      transform: translateY(1px);
      box-shadow:
        0 1px 0 #6d5216,
        0 0 10px rgba(255, 215, 128, 0.5);
    }

    /* --- Header --- */

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .logo-text {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sheikh-badge {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 3px solid #f6e688;
      background: radial-gradient(circle at 30% 5%, #fff 0, #f7d777 18%, #d88c3b 38%, #5b2613 78%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 42px;
      box-shadow:
        0 0 16px rgba(0,0,0,0.9),
        0 0 22px rgba(255, 215, 128, 0.8);
    }

    h1 {
      font-size: 32px;
      letter-spacing: 2px;
      color: #ffe37a;
      text-shadow:
        0 0 10px rgba(0,0,0,0.9),
        0 0 20px rgba(255, 186, 73, 0.9);
    }

    .subtitle {
      font-size: 13px;
      color: #f0dab0;
      opacity: 0.9;
    }

    .panel-small {
      padding: 7px 11px;
      border-radius: 14px;
      border: 1px solid #c7973a;
      background: linear-gradient(135deg, #2a1710, #3d2011);
      box-shadow: 0 0 12px rgba(0,0,0,0.9);
      font-size: 12px;
      text-align: right;
      line-height: 1.4;
      max-width: 340px;
    }

    /* --- Slot Area --- */

    .slot-area {
      margin-top: 10px;
      background:
        radial-gradient(circle at top, #4a2715 0, #1a0907 40%, #070208 100%);
      border-radius: 20px;
      border: 3px solid #cfa43c;
      box-shadow:
        0 14px 30px rgba(0,0,0,0.9),
        0 0 32px rgba(255, 204, 102, 0.35) inset;
      padding: 18px 20px 16px;
      transform-origin: center top;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .slot-area.spinning {
      transform: perspective(900px) rotateX(10deg) scale(1.02);
      box-shadow:
        0 24px 38px rgba(0,0,0,0.95),
        0 0 42px rgba(255, 204, 102, 0.55) inset;
    }

    .reels {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 18px;
      height: 430px;
    }

    .symbol {
      background:
        linear-gradient(145deg, #6a3820, #3d1c13);
      border-radius: 14px;
      border: 2px solid #905528;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 46px;
      box-shadow:
        inset 4px 4px 7px rgba(0,0,0,0.75),
        inset -4px -4px 9px rgba(255, 204, 128, 0.18);
      position: relative;
      overflow: hidden;
      transition:
        transform 0.15s ease,
        box-shadow 0.15s ease,
        border-color 0.15s ease,
        background 0.15s ease;
    }

    .symbol::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.18), transparent 42%, rgba(0,0,0,0.55) 70%);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .symbol.win {
      border-color: #ffe47d;
      box-shadow:
        0 0 18px rgba(255, 235, 145, 0.9),
        inset 0 0 10px rgba(0,0,0,0.8);
      transform: translateY(-2px) scale(1.06);
      background: linear-gradient(135deg, #8d5426, #4d2214);
    }

    /* --- Controls --- */

    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 15px;
    }

    .controls-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .label {
      color: #f7e4ad;
      font-weight: 600;
      text-shadow: 0 0 4px rgba(0,0,0,0.8);
    }

    .value-box {
      padding: 6px 12px;
      border-radius: 11px;
      min-width: 90px;
      text-align: center;
      font-weight: 700;
      background: linear-gradient(135deg, #271310, #422219);
      border: 1px solid #b07b37;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.8);
      font-size: 15px;
    }

    button.small-btn {
      padding: 6px 11px;
      border-radius: 999px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, #f3cf7d, #c4872e);
      color: #33200c;
      box-shadow: 0 2px 0 #8b6324;
      font-size: 14px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    button.small-btn:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }

    button.small-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 #6e4f1c;
    }

    button.small-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .spin-btn {
      padding: 9px 24px;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #fff8d4 0, #ffd769 37%, #e29930 68%, #763415 100%);
      color: #3a200b;
      box-shadow:
        0 3px 0 #8f6123,
        0 0 22px rgba(255, 241, 188, 0.9);
    }

    .spin-btn.glow {
      box-shadow:
        0 3px 0 #8f6123,
        0 0 28px rgba(255, 241, 188, 1);
    }

    .message {
      margin-top: 10px;
      min-height: 24px;
      font-size: 15px;
      text-align: center;
      color: #ffeac1;
      text-shadow: 0 0 5px rgba(0,0,0,0.7);
    }

    .footer-note {
      margin-top: 7px;
      font-size: 12px;
      text-align: center;
      color: #ccb184;
      opacity: 0.9;
    }

    /* --- PowerPlay Overlay --- */

    .powerspin-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0,0,0,0.96), rgba(0,0,0,0.98));
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 24px;
      z-index: 55;
    }

    .powerspin-overlay.active {
      display: flex;
    }

    .powerspin-title {
      font-size: 28px;
      margin-bottom: 8px;
      text-align: center;
      color: #ffe37a;
      text-shadow:
        0 0 14px rgba(0,0,0,0.9),
        0 0 22px rgba(255, 215, 128, 0.9);
    }

    .powerspin-sub {
      font-size: 14px;
      text-align: center;
      margin-bottom: 16px;
      color: #f3d9a3;
      max-width: 540px;
    }

    .powerspin-grids {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 14px;
      width: 100%;
      max-width: 780px;
      margin-bottom: 16px;
    }

    .mini-grid {
      background: radial-gradient(circle at top, #3f1d13, #120707);
      border-radius: 16px;
      border: 2px solid #cda53f;
      padding: 7px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 4px;
      box-shadow:
        0 0 18px rgba(0,0,0,0.9),
        0 0 20px rgba(255, 203, 112, 0.35) inset;
    }

    .mini-symbol {
      background: linear-gradient(145deg, #64341f, #391911);
      border-radius: 8px;
      border: 1px solid #8d5627;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow:
        inset 2px 2px 4px rgba(0,0,0,0.78),
        inset -2px -2px 5px rgba(255, 211, 137, 0.18);
      position: relative;
      overflow: hidden;
    }

    .mini-symbol::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.18), transparent 45%, rgba(0,0,0,0.6) 75%);
      mix-blend-mode: screen;
    }

    .powerspin-footer {
      font-size: 13px;
      margin-bottom: 10px;
      text-align: center;
      color: #f4dca4;
    }

    .overlay-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 6px;
    }

    .footer-note-overlay {
      font-size: 11px;
      color: #c7aa73;
      text-align: center;
      opacity: 0.85;
    }

    button.overlay-btn {
      padding: 7px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ffe183, #c58c32);
      color: #3b220b;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 0 #8c6223;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    button.overlay-btn:hover {
      filter: brightness(1.07);
      transform: translateY(-1px);
    }

    button.overlay-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 #6b4a1a;
    }

    button.overlay-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    @media (max-width: 900px) {
      .game-wrapper {
        padding: 14px 12px 18px;
      }
      .reels {
        gap: 6px;
        height: 360px;
      }
      .symbol {
        font-size: 32px;
      }
      header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      .panel-small {
        align-self: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="game-wrapper">
    <!-- Intro (Start) -->
    <div id="intro-overlay" class="intro-overlay">
      <div class="intro-logo">üßî‚Äç‚ôÇÔ∏è</div>
      <div class="intro-title">Lucky&nbsp;Scheisch</div>
      <div class="intro-sub">
        Willkommen im Palast des Scheischs!<br />
        Dies ist eine <strong>reine Demo</strong> ohne echtes Geld.
        Eins√§tze und Gewinne werden in <strong>Euro</strong> angezeigt, wie an einem Automaten.
      </div>
      <button id="intro-start" class="btn-big">Spiel starten</button>
    </div>

    <!-- PowerPlay Overlay -->
    <div id="powerspin" class="powerspin-overlay">
      <div class="powerspin-title">POWERPLAY ‚Äì 4-fach Bildschirm!</div>
      <div class="powerspin-sub">
        Dein Gewinn liegt bei mindestens <strong>4√ó Einsatz</strong>.<br />
        Starte jetzt den PowerPlay des Scheischs: Vier 3√ó3-Grids
        flackern gleichzeitig ‚Äì √§hnlich wie bei Lucky Pharaoh.
      </div>
      <div class="powerspin-grids">
        <div class="mini-grid" id="mini-1"></div>
        <div class="mini-grid" id="mini-2"></div>
        <div class="mini-grid" id="mini-3"></div>
        <div class="mini-grid" id="mini-4"></div>
      </div>
      <div id="powerspin-footer" class="powerspin-footer"></div>
      <div class="overlay-buttons">
        <button id="powerspin-start" class="overlay-btn">PowerPlay starten</button>
        <button id="powerspin-close" class="overlay-btn" disabled>Zur√ºck zum Spiel</button>
      </div>
      <div class="footer-note-overlay">
        Hinweis: Demo-Simulation, keine Echtgeld-Auszahlung.
      </div>
    </div>

    <header>
      <div class="logo-text">
        <div class="sheikh-badge">üßî‚Äç‚ôÇÔ∏è</div>
        <div>
          <h1>Lucky Scheisch</h1>
          <div class="subtitle">Diamant-Slot im W√ºstentempel (Demo)</div>
        </div>
      </div>
      <div class="panel-small">
        <div><strong>Modus:</strong> Fun-Play (kein Echtgeld)</div>
        <div>Treffer ‚â• 4√ó Einsatz ‚Üí PowerPlay mit 4 Screens & Extra-Effekten.</div>
      </div>
    </header>

    <main>
      <div id="slot-area" class="slot-area">
        <div id="reels" class="reels"></div>

        <div class="controls-row">
          <div class="controls-group">
            <span class="label">Einsatz</span>
            <button id="bet-minus" class="small-btn">‚àí</button>
            <div id="bet-value" class="value-box">0,00 ‚Ç¨</div>
            <button id="bet-plus" class="small-btn">+</button>
          </div>

          <div class="controls-group">
            <span class="label">Guthaben</span>
            <div id="balance" class="value-box">0,00 ‚Ç¨</div>
          </div>

          <div class="controls-group">
            <span class="label">Gewinn</span>
            <div id="last-win" class="value-box">0,00 ‚Ç¨</div>
          </div>

          <div class="controls-group">
            <button id="spin-btn" class="small-btn spin-btn" disabled>Spin</button>
          </div>
        </div>

        <div id="message" class="message"></div>
        <div class="footer-note">
          Hohe Symbole: üíé Diamant (x5 Basis) &nbsp;|&nbsp; üßî‚Äç‚ôÇÔ∏è Scheisch (x8 Basis)<br />
          Mittlere Symbole: üê™ Kamel, üè∫ Krug, üî∫ Rubin &nbsp;|&nbsp; Niedrig: K / Q / J ‚Äì alles als ‚Ç¨-Gewinne berechnet.
        </div>
      </div>
    </main>
  </div>

  <script>
    // --- Web-Audio Engine f√ºr Soundeffekte ---
    const audioEngine = {
      ctx: null,
      masterGain: null,
      init() {
        if (this.ctx) {
          if (this.ctx.state === "suspended") {
            this.ctx.resume().catch(() => {});
          }
          return;
        }
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        this.ctx = new AudioContext();
        this.masterGain = this.ctx.createGain();
        this.masterGain.gain.value = 0.18;
        this.masterGain.connect(this.ctx.destination);
      },
      playBeep(freq = 440, duration = 0.12, type = "sine", volume = 1) {
        if (!this.ctx || this.ctx.state === "closed") return;
        const now = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, now);
        gain.gain.setValueAtTime(volume, now);
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.start(now);
        osc.stop(now + duration);
      },
      playSweep(from = 220, to = 880, duration = 0.4, type = "sawtooth", volume = 0.8) {
        if (!this.ctx || this.ctx.state === "closed") return;
        const now = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(from, now);
        osc.frequency.linearRampToValueAtTime(to, now + duration);
        gain.gain.setValueAtTime(volume, now);
        gain.gain.linearRampToValueAtTime(0.0, now + duration);
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.start(now);
        osc.stop(now + duration + 0.05);
      },
      click() {
        this.playBeep(650, 0.06, "square", 0.6);
      },
      spinStart() {
        this.playSweep(200, 700, 0.4, "sawtooth", 0.7);
      },
      spinStop() {
        this.playBeep(280, 0.15, "triangle", 0.6);
      },
      winSmall() {
        this.playBeep(600, 0.14, "square", 0.7);
        this.playBeep(760, 0.18, "square", 0.7);
      },
      winBig() {
        this.playBeep(520, 0.18, "square", 0.9);
        this.playBeep(780, 0.2, "square", 0.9);
        this.playBeep(1040, 0.22, "square", 0.9);
      },
      powerStart() {
        this.playSweep(350, 1200, 0.5, "sawtooth", 0.9);
      }
    };

    // --- Hilfsfunktionen f√ºr Euro-Anzeige ---
    function formatEuro(cents) {
      const euros = cents / 100;
      return euros.toFixed(2).replace(".", ",") + " ‚Ç¨";
    }

    // --- Grundparameter ---
    const rows = 3;
    const cols = 5;

    const symbols = [
      { name: "diamond", emoji: "üíé", basePayout: 5 },
      { name: "sheikh",  emoji: "üßî‚Äç‚ôÇÔ∏è", basePayout: 8 },
      { name: "camel",   emoji: "üê™",    basePayout: 3 },
      { name: "vase",    emoji: "üè∫",    basePayout: 2 },
      { name: "ruby",    emoji: "üî∫",    basePayout: 2 },
      { name: "K",       emoji: "K",     basePayout: 1 },
      { name: "Q",       emoji: "Q",     basePayout: 1 },
      { name: "J",       emoji: "J",     basePayout: 1 }
    ];

    // Symbol-H√§ufigkeit (je h√∂her, desto √∂fter)
    const weights = [5, 3, 7, 8, 6, 10, 10, 10];

    // Geld in Cent
    let balanceCents = 10000; // 100,00 ‚Ç¨
    let betCents = 100;       // 1,00 ‚Ç¨
    let lastWinCents = 0;

    const MIN_BET = 20;    // 0,20 ‚Ç¨
    const MAX_BET = 2000;  // 20,00 ‚Ç¨
    const BET_STEP = 20;   // 0,20 ‚Ç¨

    let grid = [];
    let spinning = false;
    let gameStarted = false;

    const reelsEl = document.getElementById("reels");
    const messageEl = document.getElementById("message");
    const balanceEl = document.getElementById("balance");
    const betValueEl = document.getElementById("bet-value");
    const lastWinEl = document.getElementById("last-win");
    const spinBtn = document.getElementById("spin-btn");
    const betMinusBtn = document.getElementById("bet-minus");
    const betPlusBtn = document.getElementById("bet-plus");
    const slotAreaEl = document.getElementById("slot-area");

    // Intro
    const introOverlay = document.getElementById("intro-overlay");
    const introStart = document.getElementById("intro-start");

    // PowerPlay
    const powerspinOverlay = document.getElementById("powerspin");
    const powerspinFooter = document.getElementById("powerspin-footer");
    const powerspinStartBtn = document.getElementById("powerspin-start");
    const powerspinCloseBtn = document.getElementById("powerspin-close");

    const miniIds = ["mini-1", "mini-2", "mini-3", "mini-4"];
    let powerspinSpinning = false;
    let powerspinTimer = null;

    // Paylines: 3 horizontale Linien
    const paylines = [
      [ {r:0,c:0},{r:0,c:1},{r:0,c:2},{r:0,c:3},{r:0,c:4} ],
      [ {r:1,c:0},{r:1,c:1},{r:1,c:2},{r:1,c:3},{r:1,c:4} ],
      [ {r:2,c:0},{r:2,c:1},{r:2,c:2},{r:2,c:3},{r:2,c:4} ]
    ];

    function initGrid() {
      grid = [];
      reelsEl.innerHTML = "";
      for (let r = 0; r < rows; r++) {
        const row = [];
        for (let c = 0; c < cols; c++) {
          const sym = randomSymbol();
          row.push(sym);
          const el = document.createElement("div");
          el.className = "symbol";
          el.dataset.row = r;
          el.dataset.col = c;
          el.textContent = sym.emoji;
          reelsEl.appendChild(el);
        }
        grid.push(row);
      }
    }

    function randomSymbol() {
      const totalWeight = weights.reduce((a, b) => a + b, 0);
      let rnd = Math.random() * totalWeight;
      for (let i = 0; i < symbols.length; i++) {
        if (rnd < weights[i]) return symbols[i];
        rnd -= weights[i];
      }
      return symbols[symbols.length - 1];
    }

    function updateGridDisplay(winPositions = []) {
      const children = Array.from(reelsEl.children);
      for (const child of children) {
        child.classList.remove("win");
      }

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const index = r * cols + c;
          const el = children[index];
          el.textContent = grid[r][c].emoji;

          if (winPositions.some(pos => pos.r === r && pos.c === c)) {
            el.classList.add("win");
          }
        }
      }
    }

    function evaluateWin() {
      let totalWinCents = 0;
      let winPositions = [];

      for (const line of paylines) {
        const first = grid[line[0].r][line[0].c];
        let count = 1;
        for (let i = 1; i < line.length; i++) {
          const sym = grid[line[i].r][line[i].c];
          if (sym.name === first.name) {
            count++;
          } else {
            break;
          }
        }
        if (count >= 3) {
          const lineWinCents = first.basePayout * betCents * count;
          totalWinCents += lineWinCents;
          for (let i = 0; i < count; i++) {
            winPositions.push(line[i]);
          }
        }
      }

      updateGridDisplay(winPositions);
      return totalWinCents;
    }

    // Gewinnchance deutlich erh√∂hen:
    // Wenn kein Gewinn, mit ca. 35 % Wahrscheinlichkeit
    // eine zuf√§llige 3‚Äì4er Kombination mit mittlerem/hohen Symbol erzeugen.
    function maybeBoostWin(currentWinCents) {
      if (currentWinCents > 0) return currentWinCents;

      const chance = 0.35; // 35 % ‚Äûnachhelfen‚Äú
      if (Math.random() > chance) return 0;

      const rowIndex = Math.floor(Math.random() * rows);
      const goodSymbols = symbols.filter(s => s.basePayout >= 2);
      const chosen = goodSymbols[Math.floor(Math.random() * goodSymbols.length)];

      let count = 3;
      if (Math.random() < 0.45) count = 4;
      if (count > cols) count = cols;

      for (let c = 0; c < count; c++) {
        grid[rowIndex][c] = chosen;
      }

      const boostedWin = evaluateWin();
      return boostedWin;
    }

    function spin() {
      if (!gameStarted) return;
      if (spinning) return;
      if (betCents > balanceCents) {
        showMessage("Nicht genug Guthaben f√ºr diesen Einsatz.");
        return;
      }

      spinning = true;
      spinBtn.disabled = true;
      betMinusBtn.disabled = true;
      betPlusBtn.disabled = true;
      spinBtn.classList.remove("glow");
      slotAreaEl.classList.add("spinning");
      showMessage("Der Scheisch dreht die Walzen ...");
      audioEngine.spinStart();

      balanceCents -= betCents;
      updateBalance();

      let steps = 7;
      const interval = setInterval(() => {
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            grid[r][c] = randomSymbol();
          }
        }
        updateGridDisplay();
        steps--;
        if (steps <= 0) {
          clearInterval(interval);
          let winCents = evaluateWin();
          winCents = maybeBoostWin(winCents);
          finishSpin(winCents);
        }
      }, 95);
    }

    function finishSpin(winCents) {
      audioEngine.spinStop();

      if (winCents > 0) {
        balanceCents += winCents;
        lastWinCents = winCents;
        updateBalance();
        updateLastWin();

        if (winCents >= betCents * 4) {
          showMessage(
            `Gro√üer Gewinn: ${formatEuro(winCents)} (‚â• 4√ó Einsatz ${formatEuro(betCents)}) ‚Äì PowerPlay verf√ºgbar.`
          );
          audioEngine.winBig();
          preparePowerspin(winCents);
        } else {
          showMessage(`Gewinn: ${formatEuro(winCents)} bei Einsatz ${formatEuro(betCents)}.`);
          audioEngine.winSmall();
        }
      } else {
        lastWinCents = 0;
        updateLastWin();
        showMessage("Kein Gewinn. Der Scheisch fordert einen neuen Spin.");
      }

      spinning = false;
      spinBtn.disabled = false;
      betMinusBtn.disabled = false;
      betPlusBtn.disabled = false;
      slotAreaEl.classList.remove("spinning");
      spinBtn.classList.add("glow");
    }

    function showMessage(text) {
      messageEl.textContent = text;
    }

    function updateBalance() {
      balanceEl.textContent = formatEuro(balanceCents);
    }

    function updateLastWin() {
      lastWinEl.textContent = formatEuro(lastWinCents);
    }

    function setBet(newBetCents) {
      betCents = Math.max(MIN_BET, Math.min(MAX_BET, newBetCents));
      betValueEl.textContent = formatEuro(betCents);
    }

    // --- PowerPlay-Logik ---

    function preparePowerspin(winCents) {
      miniIds.forEach(id => {
        const container = document.getElementById(id);
        container.innerHTML = "";
        for (let i = 0; i < 9; i++) {
          const miniEl = document.createElement("div");
          miniEl.className = "mini-symbol";
          miniEl.textContent = randomSymbol().emoji;
          container.appendChild(miniEl);
        }
      });

      powerspinFooter.textContent =
        `PowerPlay verf√ºgbar! Vorheriger Gewinn: ${formatEuro(winCents)} (‚â• 4√ó Einsatz).`;

      powerspinOverlay.classList.add("active");
      powerspinStartBtn.disabled = false;
      powerspinCloseBtn.disabled = true;
    }

    function animateMiniGrids() {
      miniIds.forEach(id => {
        const container = document.getElementById(id);
        const minis = Array.from(container.children);
        minis.forEach(el => {
          el.textContent = randomSymbol().emoji;
        });
      });
    }

    function startPowerspin() {
      if (powerspinSpinning) return;
      powerspinSpinning = true;
      powerspinStartBtn.disabled = true;
      powerspinCloseBtn.disabled = true;
      powerspinFooter.textContent = "PowerPlay l√§uft ‚Äì vier Bildschirme flackern im Palast ...";
      audioEngine.powerStart();

      let steps = 20; // Dauer der PowerPlay-Animation
      powerspinTimer = setInterval(() => {
        animateMiniGrids();
        steps--;
        if (steps <= 0) {
          clearInterval(powerspinTimer);
          powerspinTimer = null;
          powerspinSpinning = false;
          powerspinFooter.textContent = "PowerPlay beendet. Der Scheisch ist zufrieden.";
          audioEngine.winBig();
          powerspinCloseBtn.disabled = false;
        }
      }, 90);
    }

    function closePowerspin() {
      if (powerspinSpinning) return; // erst Animation beenden
      powerspinOverlay.classList.remove("active");
      powerspinFooter.textContent = "";
    }

    // --- Intro-Logik ---

    introStart.addEventListener("click", () => {
      audioEngine.init();
      audioEngine.click();
      gameStarted = true;
      introOverlay.style.display = "none";
      spinBtn.disabled = false;
      spinBtn.classList.add("glow");
      showMessage("Willkommen bei Lucky Scheisch! Dr√ºcke SPIN, um zu starten.");
    });

    // --- Events ---

    spinBtn.addEventListener("click", () => {
      audioEngine.click();
      spin();
    });

    betMinusBtn.addEventListener("click", () => {
      audioEngine.click();
      setBet(betCents - BET_STEP);
    });

    betPlusBtn.addEventListener("click", () => {
      audioEngine.click();
      setBet(betCents + BET_STEP);
    });

    powerspinStartBtn.addEventListener("click", () => {
      audioEngine.click();
      startPowerspin();
    });

    powerspinCloseBtn.addEventListener("click", () => {
      audioEngine.click();
      closePowerspin();
    });

    // --- Initialisierung ---
    initGrid();
    updateBalance();
    updateLastWin();
    setBet(betCents);
    showMessage("Tippe auf ‚ÄûSpiel starten‚Äú, um den Palast des Scheischs zu betreten.");
  </script>
</body>
</html>
