<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BEDOX Fußballmanager – Frankfurt Arena</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#101725; --line:#223; --accent:#68d; --text:#eaeef7;
      --btn:#1f3159; --btnH:#2a4174; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    #wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px}
    h2{margin:8px 0 2px}
    .bar, .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}
    .small{font-size:12px;opacity:.85}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px}
    .btn{background:var(--btn);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:var(--btnH)}
    select, input[type="range"]{background:#0f172a;color:#e5e7eb;border:1px solid #334; border-radius:8px;padding:6px}
    canvas{background:#0b0f1a;border:1px solid #223;max-width:100%;height:auto;border-radius:8px}
    #log{max-height:220px;overflow:auto;white-space:pre-wrap;background:#0d1424;border:1px solid #213; padding:8px;border-radius:8px;font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid #234;background:#0e1a33}
    .score{font:700 28px system-ui,sans-serif}
    .hidden{display:none}
  </style>
</head>
<body>
<div id="wrap">
  <h2>BEDOX Fußballmanager – Frankfurt Arena</h2>
  <div class="bar small">Manager-Modus: Zwei Teams spielen per KI gegeneinander – mit Live-Visualisierung. P = Pause/Weiter · R = Neustart</div>

  <!-- Setup -->
  <div id="setup" class="card">
    <div class="row">
      <div>
        <div class="small">Team Links</div>
        <select id="teamL"></select>
      </div>
      <div>
        <div class="small">Formation Links</div>
        <select id="formL">
          <option value="433">4-3-3</option>
          <option value="442">4-4-2</option>
        </select>
      </div>
      <div>
        <div class="small">Team Rechts</div>
        <select id="teamR"></select>
      </div>
      <div>
        <div class="small">Formation Rechts</div>
        <select id="formR">
          <option value="433">4-3-3</option>
          <option value="442" selected>4-4-2</option>
        </select>
      </div>
      <button id="randomize" class="btn">Zufällige Kader</button>
      <button id="start" class="btn">Match starten</button>
    </div>
    <div class="row small" style="margin-top:6px">
      <span class="pill">Tipp: Erst Teams/Formation wählen → „Match starten“</span>
    </div>
  </div>

  <!-- HUD -->
  <div class="bar">
    <div class="score" id="score">0 : 0</div>
    <div class="pill" id="minute">00:00</div>
    <div class="pill" id="statePill">Vorbereitung</div>
    <div class="row">
      <label class="small">Sim-Speed: <span id="spdLbl">1.0×</span></label>
      <input id="speed" type="range" min="0.5" max="4" step="0.5" value="1">
      <button id="pauseBtn" class="btn">Pause</button>
      <button id="resetBtn" class="btn">Neustart</button>
    </div>
  </div>

  <canvas id="pitch" width="960" height="540"></canvas>

  <div class="card" style="max-width:960px;width:100%">
    <div class="small" style="margin-bottom:6px">Ereignisse</div>
    <div id="log"></div>
  </div>
</div>

<script>
/* ==============================
   TEAMS & DATA
================================*/
const TEAMS_PRESETS = [
  mkTeamPreset("BEDOX United", "#f59e0b", ["Sevban","Bedri","Haydar","Ali","Can","Mert","Ilyas","Timur","Onur","Arda","Emre"]),
  mkTeamPreset("Frankfurt Skyline FC", "#60a5fa", ["Max","Jonas","Leo","Paul","Finn","Felix","Elias","Noah","Luca","Moritz","Mika"]),
  mkTeamPreset("Mainz Flipsters", "#34d399", ["Tom","Jan","Eric","Phil","Sami","Yunus","Ibo","Marc","Ben","Lars","Roman"]),
  mkTeamPreset("Wiesbaden Builders", "#a78bfa", ["Aykut","Sinan","Efe","Serkan","Hakan","Umut","Okan","Baran","Deniz","Kaan","Kerem"])
];

function mkTeamPreset(name, color, names){
  return {
    name, color,
    baseSkill: rnd(55,75),
    names
  };
}

function mkPlayer(name, sideColor){
  return {
    name,
    spd: rnd(55,95),     // Geschwindigkeit
    pas: rnd(55,95),     // Passen
    sht: rnd(55,95),     // Schuss
    def: rnd(55,95),     // Defensiv
    color: sideColor,
    x:0,y:0,vx:0,vy:0, r:10, // gesetzt beim Aufstellen
    homeX:0,homeY:0,
    hasBall:false
  };
}

function mkTeam(preset, side, formation){
  const names = [...preset.names];
  const players = [];
  for(let i=0;i<11;i++){
    const n = names[i] || ("Spieler "+(i+1));
    players.push(mkPlayer(n, preset.color));
  }
  return {
    name: preset.name,
    color: preset.color,
    side, // "L" | "R"
    formation,
    players,
    score:0
  };
}

/* ==============================
   FORMATIONS (normalized layout)
   coords in [0..1] left-to-right; mirrored for right side
================================*/
const FORM = {
  "433":[ // GK + 4 D + 3 M + 3 F
    [0.05,0.50], // GK
    [0.20,0.20],[0.20,0.38],[0.20,0.62],[0.20,0.80],
    [0.45,0.30],[0.45,0.50],[0.45,0.70],
    [0.72,0.25],[0.72,0.50],[0.72,0.75]
  ],
  "442":[ // GK + 4 D + 4 M + 2 F
    [0.05,0.50],
    [0.20,0.22],[0.20,0.38],[0.20,0.62],[0.20,0.78],
    [0.45,0.28],[0.45,0.44],[0.45,0.56],[0.45,0.72],
    [0.72,0.40],[0.72,0.60]
  ]
};

function placeTeam(team, W,H){
  const P = team.players;
  const f = FORM[team.formation];
  for(let i=0;i<P.length;i++){
    const [nx,ny]=f[i];
    const rx = team.side==="L" ? nx : 1-nx;
    P[i].x = P[i].homeX = 40 + rx*(W-80);
    P[i].y = P[i].homeY = 30 + ny*(H-60);
    P[i].vx = P[i].vy = 0;
    P[i].hasBall = false;
  }
}

/* ==============================
   ENGINE & MATCH
================================*/
const canvas = document.getElementById("pitch");
const g = canvas.getContext("2d");
const W = canvas.width, H = canvas.height;

const GOAL_H = 150, GOAL_W = 10;
const MID = {x:W/2, y:H/2};
const FRIC = 0.98;
const PLAYER_ACC = 900;
const PLAYER_MAX = 150;
const DT_FIX = 1/60;

let TEAM_L=null, TEAM_R=null;
let BALL=null, STATE="setup";
let speed = 1.0;
let last=null, acc=0;
let simMinute = 0;                 // 0..90
const MINUTES_PER_REAL_SEC_AT_1X = 12; // 90 Min ~ 7.5 echte Min bei 1x

const elTeamL = document.getElementById("teamL");
const elTeamR = document.getElementById("teamR");
const elFormL = document.getElementById("formL");
const elFormR = document.getElementById("formR");
const elScore = document.getElementById("score");
const elMinute= document.getElementById("minute");
const elState = document.getElementById("statePill");
const elLog   = document.getElementById("log");
const elSpeed = document.getElementById("speed");
const elSpdLbl= document.getElementById("spdLbl");

function fillTeamSelects(){
  for(const p of TEAMS_PRESETS){
    const o1=document.createElement("option"); o1.value=p.name; o1.textContent=p.name; elTeamL.appendChild(o1);
    const o2=document.createElement("option"); o2.value=p.name; o2.textContent=p.name; elTeamR.appendChild(o2.cloneNode(true));
  }
  elTeamL.value = TEAMS_PRESETS[0].name;
  elTeamR.value = TEAMS_PRESETS[1].name;
}
fillTeamSelects();

function presetByName(n){ return TEAMS_PRESETS.find(t=>t.name===n) || TEAMS_PRESETS[0]; }

function kickoff(side="L"){
  // Ball in Mitte, leichter Impuls
  BALL = { x:MID.x, y:MID.y, vx:(side==="L"?80:-80), vy:rnd(-30,30), r:6, owner:null };
  TEAM_L.players.forEach(p=>p.hasBall=false);
  TEAM_R.players.forEach(p=>p.hasBall=false);
}

function startMatch(){
  TEAM_L = mkTeam(presetByName(elTe_
