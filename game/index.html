<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BEDOX Fußballmanager – Frankfurt Arena</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#101725; --line:#223; --accent:#68d; --text:#eaeef7;
      --btn:#1f3159; --btnH:#2a4174; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    #wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px}
    h2{margin:8px 0 2px}
    .bar, .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}
    .small{font-size:12px;opacity:.85}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px}
    .btn{background:var(--btn);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:var(--btnH)}
    select, input[type="range"]{background:#0f172a;color:#e5e7eb;border:1px solid #334; border-radius:8px;padding:6px}
    canvas{background:#0b0f1a;border:1px solid #223;max-width:100%;height:auto;border-radius:8px}
    #log{max-height:220px;overflow:auto;white-space:pre-wrap;background:#0d1424;border:1px solid #213; padding:8px;border-radius:8px;font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid #234;background:#0e1a33}
    .score{font:700 28px system-ui,sans-serif}
    .hidden{display:none}
  </style>
</head>
<body>
<div id="wrap">
  <h2>BEDOX Fußballmanager – Frankfurt Arena</h2>
  <div class="bar small">Manager-Modus: Zwei Teams spielen per KI gegeneinander – mit Live-Visualisierung. P = Pause/Weiter · R = Neustart</div>

  <!-- Setup -->
  <div id="setup" class="card">
    <div class="row">
      <div>
        <div class="small">Team Links</div>
        <select id="teamL"></select>
      </div>
      <div>
        <div class="small">Formation Links</div>
        <select id="formL">
          <option value="433">4-3-3</option>
          <option value="442">4-4-2</option>
        </select>
      </div>
      <div>
        <div class="small">Team Rechts</div>
        <select id="teamR"></select>
      </div>
      <div>
        <div class="small">Formation Rechts</div>
        <select id="formR">
          <option value="433">4-3-3</option>
          <option value="442" selected>4-4-2</option>
        </select>
      </div>
      <button id="randomize" class="btn">Zufällige Kader</button>
      <button id="start" class="btn">Match starten</button>
    </div>
    <div class="row small" style="margin-top:6px">
      <span class="pill">Tipp: Erst Teams/Formation wählen → „Match starten“</span>
    </div>
  </div>

  <!-- HUD -->
  <div class="bar">
    <div class="score" id="score">0 : 0</div>
    <div class="pill" id="minute">00:00</div>
    <div class="pill" id="statePill">Vorbereitung</div>
    <div class="row">
      <label class="small">Sim-Speed: <span id="spdLbl">1.0×</span></label>
      <input id="speed" type="range" min="0.5" max="4" step="0.5" value="1">
      <button id="pauseBtn" class="btn">Pause</button>
      <button id="resetBtn" class="btn">Neustart</button>
    </div>
  </div>

  <canvas id="pitch" width="960" height="540"></canvas>

  <div class="card" style="max-width:960px;width:100%">
    <div class="small" style="margin-bottom:6px">Ereignisse</div>
    <div id="log"></div>
  </div>
</div>

<script>
/* ==============================
   TEAMS & DATA
================================*/
const TEAMS_PRESETS = [
  mkTeamPreset("BEDOX United", "#f59e0b", ["Sevban","Bedri","Haydar","Ali","Can","Mert","Ilyas","Timur","Onur","Arda","Emre"]),
  mkTeamPreset("Frankfurt Skyline FC", "#60a5fa", ["Max","Jonas","Leo","Paul","Finn","Felix","Elias","Noah","Luca","Moritz","Mika"]),
  mkTeamPreset("Mainz Flipsters", "#34d399", ["Tom","Jan","Eric","Phil","Sami","Yunus","Ibo","Marc","Ben","Lars","Roman"]),
  mkTeamPreset("Wiesbaden Builders", "#a78bfa", ["Aykut","Sinan","Efe","Serkan","Hakan","Umut","Okan","Baran","Deniz","Kaan","Kerem"])
];

function mkTeamPreset(name, color, names){
  return {
    name, color,
    baseSkill: rnd(55,75),
    names
  };
}

function mkPlayer(name, sideColor){
  return {
    name,
    spd: rnd(55,95),     // Geschwindigkeit
    pas: rnd(55,95),     // Passen
    sht: rnd(55,95),     // Schuss
    def: rnd(55,95),     // Defensiv
    color: sideColor,
    x:0,y:0,vx:0,vy:0, r:10, // gesetzt beim Aufstellen
    homeX:0,homeY:0,
    hasBall:false
  };
}

function mkTeam(preset, side, formation){
  const names = [...preset.names];
  const players = [];
  for(let i=0;i<11;i++){
    const n = names[i] || ("Spieler "+(i+1));
    players.push(mkPlayer(n, preset.color));
  }
  return {
    name: preset.name,
    color: preset.color,
    side, // "L" | "R"
    formation,
    players,
    score:0
  };
}

/* ==============================
   FORMATIONS (normalized layout)
   coords in [0..1] left-to-right; mirrored for right side
================================*/
const FORM = {
  "433":[ // GK + 4 D + 3 M + 3 F
    [0.05,0.50], // GK
    [0.20,0.20],[0.20,0.38],[0.20,0.62],[0.20,0.80],
    [0.45,0.30],[0.45,0.50],[0.45,0.70],
    [0.72,0.25],[0.72,0.50],[0.72,0.75]
  ],
  "442":[ // GK + 4 D + 4 M + 2 F
    [0.05,0.50],
    [0.20,0.22],[0.20,0.38],[0.20,0.62],[0.20,0.78],
    [0.45,0.28],[0.45,0.44],[0.45,0.56],[0.45,0.72],
    [0.72,0.40],[0.72,0.60]
  ]
};

function placeTeam(team, W,H){
  const P = team.players;
  const f = FORM[team.formation];
  for(let i=0;i<P.length;i++){
    const [nx,ny]=f[i];
    const rx = team.side==="L" ? nx : 1-nx;
    P[i].x = P[i].homeX = 40 + rx*(W-80);
    P[i].y = P[i].homeY = 30 + ny*(H-60);
    P[i].vx = P[i].vy = 0;
    P[i].hasBall = false;
  }
}

/* ==============================
   ENGINE & MATCH
================================*/
const canvas = document.getElementById("pitch");
const g = canvas.getContext("2d");
const W = canvas.width, H = canvas.height;

const GOAL_H = 150, GOAL_W = 10;
const MID = {x:W/2, y:H/2};
const FRIC = 0.98;
const PLAYER_ACC = 900;
const PLAYER_MAX = 150;
const DT_FIX = 1/60;

let TEAM_L=null, TEAM_R=null;
let BALL=null, STATE="setup";
let speed = 1.0;
let last=null, acc=0;
let simMinute = 0;                 // 0..90
const MINUTES_PER_REAL_SEC_AT_1X = 12; // 90 Min ~ 7.5 echte Min bei 1x

const elTeamL = document.getElementById("teamL");
const elTeamR = document.getElementById("teamR");
const elFormL = document.getElementById("formL");
const elFormR = document.getElementById("formR");
const elScore = document.getElementById("score");
const elMinute= document.getElementById("minute");
const elState = document.getElementById("statePill");
const elLog   = document.getElementById("log");
const elSpeed = document.getElementById("speed");
const elSpdLbl= document.getElementById("spdLbl");

function fillTeamSelects(){
  for(const p of TEAMS_PRESETS){
    const o1=document.createElement("option"); o1.value=p.name; o1.textContent=p.name; elTeamL.appendChild(o1);
    const o2=document.createElement("option"); o2.value=p.name; o2.textContent=p.name; elTeamR.appendChild(o2.cloneNode(true));
  }
  elTeamL.value = TEAMS_PRESETS[0].name;
  elTeamR.value = TEAMS_PRESETS[1].name;
}
fillTeamSelects();

function presetByName(n){ return TEAMS_PRESETS.find(t=>t.name===n) || TEAMS_PRESETS[0]; }

function kickoff(side="L"){
  // Ball in Mitte, leichter Impuls
  BALL = { x:MID.x, y:MID.y, vx:(side==="L"?80:-80), vy:rnd(-30,30), r:6, owner:null };
  TEAM_L.players.forEach(p=>p.hasBall=false);
  TEAM_R.players.forEach(p=>p.hasBall=false);
}

function startMatch(){
  TEAM_L = mkTeam(presetByName(elTeamL.value), "L", elFormL.value);
  TEAM_R = mkTeam(presetByName(elTeamR.value), "R", elFormR.value);
  placeTeam(TEAM_L, W,H);
  placeTeam(TEAM_R, W,H);
  TEAM_L.score = TEAM_R.score = 0;
  simMinute = 0;
  kickoff(Math.random()<0.5?"L":"R");
  STATE="play"; last=null; acc=0;
  elState.textContent = "1. Halbzeit";
  logEvt("Anpfiff! "+TEAM_L.name+" vs. "+TEAM_R.name);
}

function resetAll(){
  STATE="setup";
  elState.textContent="Vorbereitung";
  elScore.textContent="0 : 0";
  elMinute.textContent="00:00";
  elLog.textContent="";
  TEAM_L=TEAM_R=BALL=null;
}

function pauseToggle(){
  if(STATE==="play"){ STATE="pause"; elState.textContent="Pause"; }
  else if(STATE==="pause"){ STATE="play"; elState.textContent=simMinute<45?"1. Halbzeit":"2. Halbzeit"; }
}

/* ==============================
   AI & PHYSICS
================================*/
function teamAll(){ return [...TEAM_L.players, ...TEAM_R.players]; }
function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

function nearestPlayerToBall(team){
  let best=null, bd=1e9;
  for(const p of team.players){
    const d = Math.hypot(p.x-BALL.x, p.y-BALL.y);
    if(d<bd){ bd=d; best=p; }
  }
  return best;
}

function opponentTeam(team){ return team===TEAM_L?TEAM_R:TEAM_L; }
function goalX(team){ return team.side==="L" ? W-GOAL_W-4 : GOAL_W+4; } // schießen Richtung Gegner

function aiStep(dt){
  const teams=[TEAM_L,TEAM_R];
  for(const T of teams){
    const opp = opponentTeam(T);
    const carrier = nearestPlayerToBall(T);
    // Jeder Spieler hat Ziel:
    for(let i=0;i<T.players.length;i++){
      const p = T.players[i];
      let tx=p.homeX, ty=p.homeY;

      // leichte Verschiebung mit Ball-x
      const shift = clamp((BALL.x - MID.x)/(W*0.5), -0.8, 0.8);
      const dir = (T.side==="L"?1:-1);
      tx += dir * shift * 60;

      if(p===carrier){
        // Zum Ball sprinten / dribbeln
        if(dist(p,BALL)<14){
          // Ballkontrolle: dribbeln Richtung Tor, ab und zu Pass/Schuss
          p.hasBall=true; BALL.owner=p;
          const gx = goalX(T);
          const toGoal = normVec(gx - p.x, (H/2) - p.y);
          // Entscheidung
          const closeToGoal = Math.abs(p.x-gx)<160;
          const pressure = nearestOpponentDist(p, opp);
          if(closeToGoal && Math.random()<0.02){
            shoot(p, toGoal, 240 + p.sht*0.8);
          }else if(pressure<70 && Math.random()<0.04){
            const mate = pickPassTarget(p, T);
            if(mate) passBall(p, mate);
          }else{
            // Dribble
            p.vx += toGoal.x * PLAYER_ACC * dt * 0.9;
            p.vy += toGoal.y * PLAYER_ACC * dt * 0.9;
          }
          // Ball „klebt“ leicht vorne am Fuß
          BALL.x = p.x + toGoal.x*12;
          BALL.y = p.y + toGoal.y*12;
          BALL.vx *= 0.92; BALL.vy*=0.92;
        }else{
          p.hasBall=false;
          moveToward(p, BALL.x, BALL.y, dt, 1.15); // Sprintfaktor
        }
      }else{
        p.hasBall=false;
        moveToward(p, tx, ty, dt, 0.7); // in Formation halten
      }
    }
  }
}

function nearestOpponentDist(p, oppTeam){
  let bd=1e9; for(const o of oppTeam.players){ const d=Math.hypot(o.x-p.x,o.y-p.y); if(d<bd) bd=d; } return bd;
}

function pickPassTarget(p, team){
  // einfacher Heuristik: freie Mitspieler Richtung Tor
  const gx = goalX(team);
  const forward = team.side==="L" ? 1 : -1;
  const cands = team.players.filter(m=>m!==p && (forward*(m.x - p.x) > 0));
  if(!cands.length) return null;
  cands.sort((a,b)=> (Math.abs(b.y-p.y)<Math.abs(a.y-p.y)?1:-1));
  return cands[0];
}

function passBall(from, to){
  const dir = normVec(to.x - from.x, to.y - from.y);
  const power = 180 + from.pas*0.6;
  BALL.vx = dir.x * power;
  BALL.vy = dir.y * power;
  BALL.owner=null;
  from.hasBall=false;
  logEvt(minuteStr()+" Pass von "+from.name+" → "+to.name);
}

function shoot(p, dir, power){
  BALL.vx = dir.x * power;
  BALL.vy = dir.y * power;
  BALL.owner=null;
  p.hasBall=false;
  logEvt(minuteStr()+" Schuss von "+p.name+"!");
}

function moveToward(p, tx, ty, dt, factor=1){
  const dx=tx-p.x, dy=ty-p.y;
  const a = PLAYER_ACC*factor*dt;
  // Beschleunigen Richtung Ziel
  const len=Math.hypot(dx,dy)||1;
  p.vx += (dx/len)*a;
  p.vy += (dy/len)*a;
  // Clamp
  const vlen=Math.hypot(p.vx,p.vy);
  const vmax=PLAYER_MAX*(0.7+ p.spd/200);
  if(vlen>vmax){ p.vx=p.vx/vlen*vmax; p.vy=p.vy/vlen*vmax; }
  // Integrate
  p.x += p.vx*dt; p.y += p.vy*dt;
  p.vx *= 0.9; p.vy *= 0.9;
  // Spielfeldgrenzen
  p.x = clamp(p.x, 20, W-20); p.y = clamp(p.y, 20, H-20);
}

function normVec(x,y){ const l=Math.hypot(x,y)||1; return {x:x/l, y:y/l}; }

/* Ball-Physik & Tore */
function stepBall(dt){
  if(BALL.owner){ return; } // wird am Fuß geführt
  BALL.vx *= FRIC; BALL.vy *= FRIC;
  BALL.x += BALL.vx*dt; BALL.y += BALL.vy*dt;

  // Banden
  if(BALL.y < 10){ BALL.y=10; BALL.vy*=-0.85; }
  if(BALL.y > H-10){ BALL.y=H-10; BALL.vy*=-0.85; }
  if(BALL.x < 4){ // linke Tor-/Außenlinie
    // Tor für rechts?
    if(Math.abs(BALL.y - H/2) < GOAL_H/2){
      goal("R");
    }else{ BALL.x=4; BALL.vx*=-0.9; }
  }
  if(BALL.x > W-4){
    if(Math.abs(BALL.y - H/2) < GOAL_H/2){
      goal("L");
    }else{ BALL.x=W-4; BALL.vx*=-0.9; }
  }

  // Spieler-Kontakt (einfach)
  for(const p of teamAll()){
    const d = Math.hypot(BALL.x-p.x, BALL.y-p.y);
    if(d < p.r+6){
      // leichter Abpraller Richtung Spielerbewegung
      const dir = normVec(BALL.x-p.x, BALL.y-p.y);
      BALL.x = p.x + dir.x*(p.r+6);
      BALL.y = p.y + dir.y*(p.r+6);
      BALL.vx += dir.x*40 + p.vx*0.5;
      BALL.vy += dir.y*40 + p.vy*0.5;
    }
  }
}

function goal(side){ // side = "L" bekommt Tor
  if(side==="L"){ TEAM_L.score++; }
  else{ TEAM_R.score++; }
  elScore.textContent = TEAM_L.score+" : "+TEAM_R.score;
  logEvt(minuteStr()+" TOR für "+(side==="L"?TEAM_L.name:TEAM_R.name)+"!");

  // Neuaufstellung & Anstoß Gegner
  placeTeam(TEAM_L, W,H); placeTeam(TEAM_R, W,H);
  kickoff(side==="L"?"R":"L");
}

/* ==============================
   RENDERING
================================*/
function drawPitch(){
  // Rasen
  const grd = g.createLinearGradient(0,0,0,H);
  grd.addColorStop(0,"#0b1b12"); grd.addColorStop(1,"#123a22");
  g.fillStyle=grd; g.fillRect(0,0,W,H);

  // Mittelkreis & Linien
  g.strokeStyle="rgba(255,255,255,.65)"; g.lineWidth=2;
  g.strokeRect(20,20,W-40,H-40);
  g.beginPath(); g.moveTo(MID.x,20); g.lineTo(MID.x,H-20); g.stroke();
  g.beginPath(); g.arc(MID.x,MID.y,60,0,Math.PI*2); g.stroke();

  // Strafräume
  drawBox(20, H/2-80, 70, 160); // links 16er
  drawBox(W-90, H/2-80, 70, 160); // rechts 16er

  // Tore
  g.fillStyle="#d7e6ff";
  g.fillRect(0, H/2-GOAL_H/2, GOAL_W, 4);
  g.fillRect(0, H/2+GOAL_H/2-4, GOAL_W, 4);
  g.fillRect(W-GOAL_W, H/2-GOAL_H/2, GOAL_W, 4);
  g.fillRect(W-GOAL_W, H/2+GOAL_H/2-4, GOAL_W, 4);
}

function drawBox(x,y,w,h){ g.strokeStyle="rgba(255,255,255,.5)"; g.strokeRect(x,y,w,h); }

function drawTeams(){
  drawTeam(TEAM_L); drawTeam(TEAM_R);
}

function drawTeam(T){
  for(const p of T.players){
    g.fillStyle=T.color; g.beginPath(); g.arc(p.x,p.y,p.r,0,Math.PI*2); g.fill();
    g.fillStyle="rgba(0,0,0,.5)"; g.font="10px system-ui"; g.textAlign="center";
    g.fillText(p.name, p.x, p.y-14);
    if(p.hasBall){
      g.strokeStyle="#fff"; g.lineWidth=2; g.beginPath(); g.arc(p.x,p.y,p.r+3,0,Math.PI*2); g.stroke();
    }
  }
}

function drawBall(){
  g.fillStyle="#eeeeee"; g.beginPath(); g.arc(BALL.x,BALL.y,BALL.r,0,Math.PI*2); g.fill();
  g.strokeStyle="#bbbbbb"; g.lineWidth=2; g.beginPath(); g.arc(BALL.x,BALL.y,BALL.r*0.6,0,Math.PI*2); g.stroke();
}

/* ==============================
   CLOCK & LOOP
================================*/
function minuteStr(){
  const m = Math.floor(simMinute);
  const s = Math.floor((simMinute - m)*60);
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function logEvt(t){
  elLog.textContent += (t+"\n");
  elLog.scrollTop = elLog.scrollHeight;
}

function step(dt){
  if(STATE!=="play"){ return; }

  // Uhr
  simMinute += dt * MINUTES_PER_REAL_SEC_AT_1X * speed;
  if(simMinute>=45 && elState.textContent==="1. Halbzeit"){
    elState.textContent="Halbzeit";
    logEvt("Halbzeit. Spielstand: "+TEAM_L.score+" : "+TEAM_R.score);
    STATE="pause"; return;
  }
  if(elState.textContent==="Halbzeit" && STATE==="play" && simMinute<45){
    elState.textContent="2. Halbzeit";
  }
  if(simMinute>=90){
    STATE="pause";
    elState.textContent="Ende";
    logEvt("Abpfiff. Ergebnis: "+TEAM_L.name+" "+TEAM_L.score+" : "+TEAM_R.score+" "+TEAM_R.name);
  }
  elMinute.textContent = minuteStr();

  // KI & Physik
  aiStep(dt);
  stepBall(dt);
}

function render(){
  g.clearRect(0,0,W,H);
  drawPitch();
  if(TEAM_L&&TEAM_R&&BALL){
    drawTeams();
    drawBall();
  }
}

function loop(t){
  if(last===null) last=t;
  const dt = Math.min(0.05,(t-last)/1000); last=t;
  acc += dt;
  while(acc>=DT_FIX){ step(DT_FIX); acc-=DT_FIX; }
  render();
  requestAnimationFrame(loop);
}

/* ==============================
   UI HOOKS
================================*/
document.getElementById("start").addEventListener("click", startMatch);
document.getElementById("randomize").addEventListener("click", ()=>{
  // neue Namen / Skills per Preset neu laden (hier reicht „Neu starten“)
  startMatch();
});
document.getElementById("pauseBtn").addEventListener("click", ()=>{
  pauseToggle();
});
document.getElementById("resetBtn").addEventListener("click", resetAll);

document.addEventListener("keydown", (e)=>{
  const k=(e.code||e.key||"").toLowerCase();
  if(k==="keyp"||k==="p"){ pauseToggle(); }
  if(k==="keyr"||k==="r"){ resetAll(); }
});

elSpeed.addEventListener("input", ()=>{
  speed = parseFloat(elSpeed.value);
  document.getElementById("spdLbl").textContent = speed.toFixed(1)+"×";
});

/* ==============================
   HELPERS
================================*/
function rnd(a,b){ return Math.random()*(b-a)+a; }

/* ==============================
   BOOT
================================*/
resetAll();
requestAnimationFrame(loop);
</script>
</body>
</html>
